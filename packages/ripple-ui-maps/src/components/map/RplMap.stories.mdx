import {
  Canvas,
  Meta,
  Story,
  ArgsTable
} from '@storybook/addon-docs'
import { ref, provide } from 'vue'
import { RplAccordion } from '@dpc-sdp/ripple-ui-core/vue'
import RplMap from './RplMap.vue'
import RplMapProviderEsri from './providers/RplMapProviderEsri.vue'
import RplMapProviderVicMap from './providers/RplMapProviderVicMap.vue'
import RplMapProviderMapbox from './providers/RplMapProviderMapbox.vue'
import Icon from 'ol/style/Icon'
import featureData from './__fixture__/largeset.json'
import ExampleVectorLayer from './__fixture__/VectorLayer.example.vue'
import '@dpc-sdp/ripple-ui-core/style/components'
import { getIconForPopulation } from './__fixture__/utils.ts'

export const Template = (args) => ({
  components: { RplMap, RplMapProviderEsri, RplMapProviderVicMap, RplMapProviderMapbox, RplAccordion, ExampleVectorLayer },
  setup() {
    const rplMapRef = ref(null)
    const popup = ref({
      isOpen: false,
      position: [0,0],
      feature: null
    })
    const deadSpace = ref({
      left: 0,
      top: 0,
      right: 0,
      bottom: 0
    })
    function setRplMapRef(mapInstance) {
      rplMapRef.value = mapInstance
    }
    provide('rplMapInstance', {
      rplMapRef,
      setRplMapRef,
      popup,
      deadSpace
    })
    const getClusteredFeatures = (itms) => {
      return itms.map((itm, idx) => {
        return {
          id: `${idx}-${itm.title}`,
          title: itm.title,
          content: itm.description
        }
      })
    }
    return {
      getClusteredFeatures,
      args
    }
  },
  template: `
    <RplMap projection="EPSG:3857" v-bind="args">
      <template #map-provider>
        <rpl-map-provider-esri v-if="args.provider === 'esri'" />
        <rpl-map-provider-vic-map v-if="args.provider === 'vicmap'" />
        <rpl-map-provider-mapbox v-if="args.provider === 'mapbox'" />
      </template>
      <template v-if="args.vectorLayers" #shapes="{ mapFeatures }">
        <ExampleVectorLayer :results="mapFeatures" />
      </template>
      <template #popupTitle="{ selectedFeatures }">
        <span v-if="selectedFeatures.length === 1">
          {{ selectedFeatures[0].title}}
        </span>
        <span v-else>
          {{ selectedFeatures.length }} items found in this area
        </span>
      </template>
      <template #popupContent="{ selectedFeatures }">
        <div class="rpl-u-margin-4">
          <p class="rpl-type-p-small" v-if="selectedFeatures.length === 1">
            {{ selectedFeatures[0].description}}
          </p>
          <RplAccordion v-else :items="getClusteredFeatures(selectedFeatures)" :displayToggleAll="false">
          </RplAccordion>
        </div>
      </template>
    </RplMap>
  `
})

<Meta
  title='Maps/core'
  component={RplMap}
/>

# Demo

<ArgsTable of={RplMap} />

<Canvas>
  <Story
    name='Mapbox'
    args={{
      id: '123',
      features:featureData,
      provider: 'mapbox',
    }}
  >
    {Template.bind()}
  </Story>
  <Story
    name='Esri'
    args={{
      id: '123',
      features: featureData,
      provider: 'esri'
    }}
  >
    {Template.bind()}
  </Story>
  <Story
    name='Vicmap'
    args={{
      id: '123',
      provider: 'vicmap',
      projection: 'EPSG:3857',
      features:featureData
    }}
  >
    {Template.bind()}
  </Story>
  <Story
    name='Vector Layers'
    args={{
      id: '123',
      projection: 'EPSG:3857',
      features:featureData,
      provider: 'mapbox',
      popupType: 'popover',
      vectorLayers: true
    }}
  >
    {Template.bind()}
  </Story>
  <Story
    name='Custom Markers'
    args={{
      id: 'custom-markers',
      features: featureData,
      provider: 'mapbox',
      popupType: 'popover',
      pinStyle: () => {
        return new Icon({
          src: "data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M4 12C4 20.82 16 32 16 32C16 32 28 20.82 28 12C28 5.4984 22.6343 0 16 0C9.36571 0 4 5.4984 4 12Z' fill='%230052C2'/%3E%3Cpath d='M16 31.3074C15.95 31.2588 15.8949 31.2049 15.8351 31.146C15.5106 30.8266 15.0459 30.3595 14.4878 29.7712C13.371 28.5939 11.883 26.9341 10.3962 25.0025C8.90835 23.0695 7.42916 20.874 6.32371 18.6254C5.21591 16.3719 4.5 14.0982 4.5 12C4.5 5.77095 9.64544 0.5 16 0.5C22.3546 0.5 27.5 5.77095 27.5 12C27.5 14.0982 26.7841 16.3719 25.6763 18.6254C24.5708 20.874 23.0917 23.0695 21.6038 25.0025C20.117 26.9341 18.629 28.5939 17.5122 29.7712C16.9541 30.3595 16.4894 30.8266 16.1649 31.146C16.1051 31.2049 16.05 31.2588 16 31.3074Z' stroke='%231A1A1A' stroke-opacity='0.3'/%3E%3Cpath d='M16 17.5699C15.5517 17.5699 15.1674 17.4417 14.8471 17.121C14.5269 16.8003 14.3988 16.4155 14.3988 15.9665C14.3988 15.5175 14.5269 15.1327 14.8471 14.812C15.1674 14.4913 15.5517 14.3631 16 14.3631C16.4483 14.3631 16.8326 14.4913 17.1529 14.812C17.4731 15.1327 17.6012 15.5175 17.6012 15.9665C17.6012 16.4155 17.4731 16.8003 17.1529 17.121C16.8326 17.4417 16.4483 17.5699 16 17.5699ZM12.3492 13.9783C11.8368 14.4913 10.3636 13.2086 11.0041 12.5672C11.6446 11.9259 12.3492 11.4128 13.2459 11.0921C14.1426 10.7714 15.0393 10.5148 16 10.5148C16.9607 10.5148 17.9215 10.7073 18.7541 11.0921C19.5868 11.4769 20.3554 11.99 20.9959 12.6314C21.6364 13.2727 20.0992 14.4272 19.6508 13.9783C19.2025 13.5293 18.626 13.1445 18.0496 12.8879C17.4091 12.6314 16.7686 12.5031 16.0641 12.5031C15.3595 12.5031 14.655 12.5672 14.0145 12.8238C13.374 13.0803 12.8616 13.4652 12.3492 13.9783ZM9.65911 11.2204C8.82646 12.0541 7.35333 10.8997 8.31407 9.87348C9.27481 8.84729 10.4277 8.07764 11.7727 7.50041C13.1178 6.92317 14.4628 6.66663 16 6.66663C17.5372 6.66663 18.9463 6.92317 20.2273 7.50041C21.5083 8.07764 22.7252 8.84729 23.6859 9.87348C24.6467 10.8997 23.1735 12.0541 22.3409 11.2204C21.5083 10.3866 20.5475 9.7452 19.4587 9.29625C18.3698 8.84729 17.2169 8.59074 16 8.59074C14.7831 8.59074 13.6302 8.84729 12.5413 9.29625C11.4525 9.7452 10.4917 10.3866 9.65911 11.2204Z' fill='white'/%3E%3C/svg%3E",
          anchor: [0.5, 1],
          anchorXUnits: 'fraction',
          anchorYUnits: 'fraction'
        })
      },
      activePinStyle: (feature, Icon) => {
        return new Icon({
          src: "data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M4 12C4 20.82 16 32 16 32C16 32 28 20.82 28 12C28 5.4984 22.6343 0 16 0C9.36571 0 4 5.4984 4 12Z' fill='%230052C2'/%3E%3Cpath d='M16 31.3074C15.95 31.2588 15.8949 31.2049 15.8351 31.146C15.5106 30.8266 15.0459 30.3595 14.4878 29.7712C13.371 28.5939 11.883 26.9341 10.3962 25.0025C8.90835 23.0695 7.42916 20.874 6.32371 18.6254C5.21591 16.3719 4.5 14.0982 4.5 12C4.5 5.77095 9.64544 0.5 16 0.5C22.3546 0.5 27.5 5.77095 27.5 12C27.5 14.0982 26.7841 16.3719 25.6763 18.6254C24.5708 20.874 23.0917 23.0695 21.6038 25.0025C20.117 26.9341 18.629 28.5939 17.5122 29.7712C16.9541 30.3595 16.4894 30.8266 16.1649 31.146C16.1051 31.2049 16.05 31.2588 16 31.3074Z' stroke='%231A1A1A' stroke-opacity='0.3'/%3E%3Cpath d='M16 17.5699C15.5517 17.5699 15.1674 17.4417 14.8471 17.121C14.5269 16.8003 14.3988 16.4155 14.3988 15.9665C14.3988 15.5175 14.5269 15.1327 14.8471 14.812C15.1674 14.4913 15.5517 14.3631 16 14.3631C16.4483 14.3631 16.8326 14.4913 17.1529 14.812C17.4731 15.1327 17.6012 15.5175 17.6012 15.9665C17.6012 16.4155 17.4731 16.8003 17.1529 17.121C16.8326 17.4417 16.4483 17.5699 16 17.5699ZM12.3492 13.9783C11.8368 14.4913 10.3636 13.2086 11.0041 12.5672C11.6446 11.9259 12.3492 11.4128 13.2459 11.0921C14.1426 10.7714 15.0393 10.5148 16 10.5148C16.9607 10.5148 17.9215 10.7073 18.7541 11.0921C19.5868 11.4769 20.3554 11.99 20.9959 12.6314C21.6364 13.2727 20.0992 14.4272 19.6508 13.9783C19.2025 13.5293 18.626 13.1445 18.0496 12.8879C17.4091 12.6314 16.7686 12.5031 16.0641 12.5031C15.3595 12.5031 14.655 12.5672 14.0145 12.8238C13.374 13.0803 12.8616 13.4652 12.3492 13.9783ZM9.65911 11.2204C8.82646 12.0541 7.35333 10.8997 8.31407 9.87348C9.27481 8.84729 10.4277 8.07764 11.7727 7.50041C13.1178 6.92317 14.4628 6.66663 16 6.66663C17.5372 6.66663 18.9463 6.92317 20.2273 7.50041C21.5083 8.07764 22.7252 8.84729 23.6859 9.87348C24.6467 10.8997 23.1735 12.0541 22.3409 11.2204C21.5083 10.3866 20.5475 9.7452 19.4587 9.29625C18.3698 8.84729 17.2169 8.59074 16 8.59074C14.7831 8.59074 13.6302 8.84729 12.5413 9.29625C11.4525 9.7452 10.4917 10.3866 9.65911 11.2204Z' fill='white'/%3E%3C/svg%3E",
          anchor: [0.5, 1],
          anchorXUnits: 'fraction',
          anchorYUnits: 'fraction'
        })
      }
    }}
  >
    {Template.bind()}
  </Story>
</Canvas>
