import {
  Canvas,
  Meta,
  Story,
  ArgsTable
} from '@storybook/addon-docs'
import { expect } from '@storybook/jest';
import { within, userEvent, waitFor } from '@storybook/testing-library';
import RplAlert from './alert.vue'
import { RplColorThemes } from './../../lib/constants'
import { reactive, ref } from 'vue';
import { rplEventBus } from './../../index.ts';
const playFunction = async ({ canvasElement }) => {
  let fired = false
  rplEventBus.all.clear()
  const handler = () => { fired = !fired }
  rplEventBus.on('rpl-alert/dismiss', handler)
  const canvas = await within(canvasElement)
  await new Promise((r) => setTimeout(r, 2000));
  await userEvent.click(canvas.getByText('Dismiss alert'))
  await expect(fired).toBeTruthy()
  await expect(canvas.queryByText('Dismiss alert')).not.toBeInTheDocument()
  rplEventBus.off('rpl-alert/dismiss', handler)
}

export const SingleTemplate = (args) => ({
  components: { RplAlert },
  setup() {
    return { args }
  },
  template: '<RplAlert v-bind="args"></RplAlert>'
});


<Meta
  title='Components/Containers/Alert'
  component={RplAlert}
    parameters={{
    design: {
      type: 'figma',
      url:
        'https://www.figma.com/file/jtsOPNk1k4cWnumzkZgclD/Ripple-2.0-PoC?node-id=2951%3A189661',
    },
  }}
  argTypes={{
    type: {
      control: { type: 'select' },
      options: ['info', 'warning', 'error'],
      defaultValue: 'info'
    },
    iconName: {
      control: { type: 'select' },
      options: ['icon-information-circle-filled', 'icon-fire', 'icon-flood'],
      defaultValue: 'icon-information-circle-filled'
    },
    message: {
      defaultValue: 'An informative message.'
    },
    linkText: {
      type: 'string',
      defaultValue: 'Find out more'
    },
    linkUrl: {
      type: 'string',
      defaultValue: '/'
    }
  }}
/>

# Alert

<ArgsTable of={RplAlert} />

## Variants

<Canvas columns={2}>
  <Story
    name='Information'
    args={{
      type: 'info',
      iconName: 'icon-information-circle-filled',
      alertId: 'info-1'
    }}
  >
    {SingleTemplate.bind()}
  </Story>
  <Story
    name='Warning'
    args={{
      type: 'warning',
      iconName: 'icon-fire',
      alertId: 'fire-1'
    }}
  >
    {SingleTemplate.bind()}
  </Story>
  <Story
    name='Danger'
    args={{
      type: 'error',
      iconName: 'icon-exclamation-circle-filled',
      alertId: 'danger-1'
    }}
  >
    {SingleTemplate.bind()}
  </Story>
</Canvas>

## Stacked

<Canvas>
  <Story
    name='Stacked'
    args={{
      type: 'error',
      iconName: 'icon-exclamation-circle-filled'
    }}
    parameters={{ actions: { argTypesRegex: '^on.*' } }}
  >
    {(args) => {
      return {
        components: { RplAlert },
        setup() {
          const dismissed = reactive({
            info: false,
            warning: false,
            error: false,
          })
          return {
            args,
            dismissed,
            onDismiss: (id) => dismissed[id] = !dismissed[id]
          }
        },
        template: `<div style="position: relative;" v-for="(alert, i) in Object.keys(dismissed)">
            <RplAlert v-bind="args"
              :key="'alert-' + i"
              :type="alert"
              :alertId="alert"
              :dismissed="dismissed[alert]"
              @dismiss="onDismiss"
            >
            </RplAlert>
          </div>`
      }
    }}
  </Story>
</Canvas>

## Dismissed

<Canvas columns={2}>
  <Story
    name='Dismissed'
    args={{
      type: 'error',
      iconName: 'icon-exclamation-circle-filled'
    }}
    play={playFunction}
  >
    {(args) => {
      return {
        components: { RplAlert },
        setup() {
          let dismissed = ref(false)
          return {
            args,
            dismissed,
            onDismiss: (id) => {
              dismissed.value = !dismissed.value
            }
          }
        },
        template: `<div style="position: relative;">
            <RplAlert v-bind="args"
              type="info"
              alertId="123"
              :dismissed="dismissed"
              @dismiss="onDismiss"
            >
            </RplAlert>
          </div>`
      }
    }}
  </Story>
</Canvas>
